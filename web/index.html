<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Infra Providencia — DEBUG</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23007acc'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .panel{position:absolute;z-index:1000;top:10px;left:10px;background:#fff;padding:10px 12px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);font:14px system-ui,Segoe UI,Roboto,Arial;min-width:260px}
    .row{margin:.35rem 0}
    .err{color:#b00020;font-weight:600}
    .ok{color:#0a7d33}
    code{background:#f3f3f3;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="row"><label><input id="chk-infra" type="checkbox" checked> Infraestructura</label></div>
    <div class="row"><label><input id="chk-beb"   type="checkbox" checked> Bebederos</label></div>
    <div class="row"><label><input id="chk-uv" type="checkbox" checked> UV (grilla)</label></div>
    <div class="row"><label><input id="chk-temp" type="checkbox" checked> Temperatura (grilla)</label></div>
    <div class="row"><label><input id="chk-sombra" type="checkbox" checked> Sombra (12:00)</label></div>
    <div class="row">
      <label><input id="chk-route" type="checkbox"> Ruta (pgr_dijkstra)</label>
      <button id="btn-route-reset" type="button" style="margin-left:.5rem">Reset</button>
    </div>
    <div class="row" id="route-info" style="font-size:12px;color:#333"></div>
    <hr>
    <div class="row"><b>Infra:</b> <span id="infra-count">—</span></div>
    <div class="row"><b>Bebederos:</b> <span id="beb-count">—</span></div>
    <div class="row err" id="errors"></div>
    <div class="row">Ruta esperada de archivos: <code>/json/*.geojson</code></div>
    <div class="row">URL actual: <code id="url"></code></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- MAPA BASE PRIMERO (antes de cualquier uso de `map`) ---
    document.getElementById('url').textContent = window.location.pathname;

    const map = L.map('map').setView([-33.431,-70.618], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OSM'}).addTo(map);

    const infraLayer = L.layerGroup();
    const bebLayer   = L.layerGroup();

    const infraCountEl = document.getElementById('infra-count');
    const bebCountEl   = document.getElementById('beb-count');
    const errorsEl     = document.getElementById('errors');

    function logErr(msg){
      console.error(msg);
      const div=document.createElement('div'); div.textContent=msg;
      errorsEl.appendChild(div);
    }

    async function safeFetch(url){
      const u = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
      const r = await fetch(u);
      if(!r.ok){ throw new Error(`GET ${url} -> ${r.status}`); }
      return r.json();
    }

    async function loadInfra(){
      infraLayer.clearLayers();
      let total=0;
      const urls=[
        '/json/infra_provi_sector.geojson',
        '/json/infra_provi_sector_south.geojson',
        '/json/infra_provi_sector_south_exp.geojson',
        '/json/infra_provi_sector_east.geojson'
      ];
      const added=[];
      for(const url of urls){
        try{
          const g = await safeFetch(url);
          if(!g?.features?.length) continue;
          total += g.features.length;
          added.push(L.geoJSON(g,{style:()=>({weight:2})}));
        }catch(e){ logErr(e.message); }
      }
      added.forEach(l=>infraLayer.addLayer(l));
      infraCountEl.textContent = total ? `${total} features` : '0';
      if(document.getElementById('chk-infra').checked && infraLayer.getLayers().length){
        infraLayer.addTo(map);
        try{ map.fitBounds(infraLayer.getBounds(),{padding:[20,20]}); }catch(_){}
      }else{
        map.removeLayer(infraLayer);
      }
    }

    async function loadBeb(){
      bebLayer.clearLayers();
      try{
        const g = await safeFetch('/json/metadata_bebederos.geojson');
        const n = (g?.features||[]).length;
        bebCountEl.textContent = n ? `${n} puntos` : '0';
        if(n){
          const pts=L.geoJSON(g,{
            pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:5}),
            onEachFeature:(f,l)=>l.bindTooltip((f.properties?.fuente||'bebedero'))
          });
          bebLayer.addLayer(pts);
          if(document.getElementById('chk-beb').checked) bebLayer.addTo(map);
        }else{
          map.removeLayer(bebLayer);
        }
      }catch(e){
        logErr(e.message);
        bebCountEl.textContent='error';
        map.removeLayer(bebLayer);
      }
    }

    document.getElementById('chk-infra').addEventListener('change',e=>{
      e.target.checked ? infraLayer.addTo(map) : map.removeLayer(infraLayer);
    });
    document.getElementById('chk-beb').addEventListener('change',e=>{
      e.target.checked ? bebLayer.addTo(map) : map.removeLayer(bebLayer);
    });
  </script>

  <script>
    // --- Choropleth de temperatura ---
    function tempColor(t){
      if (t==null) return '#bbbbbb';
      if (t < 5)  return '#313695';
      if (t < 10) return '#4575b4';
      if (t < 15) return '#74add1';
      if (t < 20) return '#abd9e9';
      if (t < 25) return '#fdae61';
      if (t < 30) return '#f46d43';
      if (t < 35) return '#d73027';
      return '#a50026';
    }
    const tempLayer = L.layerGroup();
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','info legend');
      div.style.background='#fff'; div.style.padding='6px 8px'; div.style.borderRadius='6px';
      const grades=[5,10,15,20,25,30,35];
      let html='<b>Temp (°C)</b><br>';
      for(let i=0;i<grades.length+1;i++){
        const t = (i===0?grades[0]-1:grades[i-1]+0.01);
        html += `<i style="background:${tempColor(t)};width:12px;height:12px;display:inline-block;margin-right:4px"></i>` +
                `${i===0?'<'+grades[0]: (i===grades.length?grades[i-1]+'+':grades[i-1]+'–'+grades[i])}<br>`;
      }
      div.innerHTML=html; return div;
    };
    async function loadTemp(){
      tempLayer.clearLayers();
      try{
        const r = await fetch('/json/amenaza_temp_grid.geojson?v='+Date.now());
        if(!r.ok) throw new Error('GET amenaza_temp_grid.geojson '+r.status);
        const g = await r.json();
        const grid = L.geoJSON(g, {
          style: f => ({ color:'#666', weight:0.5, fillOpacity:0.6, fillColor: tempColor(f.properties?.temp_c) }),
          onEachFeature: (f,l) => l.bindTooltip(`T: ${f.properties?.temp_c ?? 'n/a'} °C`)
        });
        tempLayer.addLayer(grid);
        if (document.getElementById('chk-temp').checked) tempLayer.addTo(map); else map.removeLayer(tempLayer);
        if (document.getElementById('chk-temp').checked){ legend.addTo(map); } else { legend.remove(); }
      }catch(e){ console.error(e); map.removeLayer(tempLayer); legend.remove?.(); }
    }
    document.getElementById('chk-temp').addEventListener('change', e=>{
      if (e.target.checked){ tempLayer.addTo(map); legend.addTo(map); }
      else { map.removeLayer(tempLayer); legend.remove?.(); }
    });
  </script>

  <script>
    // --- UV ---
    function uvColor(u){
      if (u==null) return '#bbbbbb';
      if (u < 3)  return '#2dc937';
      if (u < 6)  return '#e7b416';
      if (u < 8)  return '#ff7f00';
      if (u < 11) return '#cc3232';
      return '#7f00ff';
    }
    const uvLayer = L.layerGroup();
    const legendUV = L.control({position:'bottomleft'});
    legendUV.onAdd = function(){
      const div = L.DomUtil.create('div','info legend');
      div.style.background='#fff'; div.style.padding='6px 8px'; div.style.borderRadius='6px';
      div.innerHTML = '<b>UV</b><br>'
        + `<i style="background:${uvColor(2.9)};display:inline-block;width:12px;height:12px;margin-right:4px"></i>0–2 (Bajo)<br>`
        + `<i style="background:${uvColor(5.0)};display:inline-block;width:12px;height:12px;margin-right:4px"></i>3–5 (Moderado)<br>`
        + `<i style="background:${uvColor(7.0)};display:inline-block;width:12px;height:12px;margin-right:4px"></i>6–7 (Alto)<br>`
        + `<i style="background:${uvColor(9.0)};display:inline-block;width:12px;height:12px;margin-right:4px"></i>8–10 (Muy alto)<br>`
        + `<i style="background:${uvColor(11.5)};display:inline-block;width:12px;height:12px;margin-right:4px"></i>11+ (Extremo)`;
      return div;
    };
    async function loadUV(){
      uvLayer.clearLayers();
      try{
        const r = await fetch('/json/amenaza_uv_grid.geojson?v='+Date.now());
        if(!r.ok) throw new Error('GET amenaza_uv_grid.geojson '+r.status);
        const g = await r.json();
        const grid = L.geoJSON(g, {
          style: f => ({ color:'#666', weight:0.5, fillOpacity:0.55, fillColor: uvColor(f.properties?.uv_index) }),
          onEachFeature: (f,l) => l.bindTooltip(`UV: ${f.properties?.uv_index ?? 'n/a'}`)
        });
        uvLayer.addLayer(grid);
        if (document.getElementById('chk-uv').checked) { uvLayer.addTo(map); legendUV.addTo(map); }
        else { map.removeLayer(uvLayer); legendUV.remove?.(); }
      }catch(e){ console.error(e); map.removeLayer(uvLayer); legendUV.remove?.(); }
    }
    document.getElementById('chk-uv').addEventListener('change', e=>{
      if (e.target.checked){ uvLayer.addTo(map); legendUV.addTo(map); }
      else { map.removeLayer(uvLayer); legendUV.remove?.(); }
    });
  </script>

  <script>
    // --- Sombras precalculadas ---
    const sombraPolysLayer = L.layerGroup();
    const sombraRoadsLayer = L.layerGroup();
    async function loadSombraStatic(){
      sombraPolysLayer.clearLayers();
      sombraRoadsLayer.clearLayers();
      try{
        const sp = await fetch('/json/sombra_poligonos.geojson?v='+Date.now()).then(r=>r.json());
        const sr = await fetch('/json/infra_sombreada.geojson?v='+Date.now()).then(r=>r.json());
        const polys = L.geoJSON(sp,{style:{color:'#000',weight:0,fillOpacity:0.25,fillColor:'#000'}});
        const roads = L.geoJSON(sr,{style:{color:'#222',weight:3}});
        sombraPolysLayer.addLayer(polys);
        sombraRoadsLayer.addLayer(roads);
        if (document.getElementById('chk-sombra').checked){
          sombraPolysLayer.addTo(map); sombraRoadsLayer.addTo(map);
        } else {
          map.removeLayer(sombraPolysLayer); map.removeLayer(sombraRoadsLayer);
        }
      }catch(e){ console.error(e); }
    }
    document.getElementById('chk-sombra').addEventListener('change', e=>{
      if (e.target.checked){ sombraPolysLayer.addTo(map); sombraRoadsLayer.addTo(map); }
      else { map.removeLayer(sombraPolysLayer); map.removeLayer(sombraRoadsLayer); }
    });
  </script>

  <script>
    // --- RUTA: este bloque VA DESPUÉS de crear el `map` ---
    const routeLayer   = L.layerGroup().addTo(map);
    const routeMarkers = L.layerGroup().addTo(map);

    let routingMode = false;
    let picks = [];

    const chkRoute = document.getElementById('chk-route');
    const btnReset = document.getElementById('btn-route-reset');
    const routeInfo = document.getElementById('route-info');

    function resetRoute() {
      picks = [];
      routeLayer.clearLayers();
      routeMarkers.clearLayers();
      routeInfo.textContent = '';
    }

    async function requestRoute() {
      if (picks.length !== 2) return;
      const src = `${picks[0].lat.toFixed(6)},${picks[0].lng.toFixed(6)}`;
      const dst = `${picks[1].lat.toFixed(6)},${picks[1].lng.toFixed(6)}`;
      routeInfo.textContent = 'Calculando ruta…';
      try {
        const r = await fetch(`http://localhost:8000/route?src=${src}&dst=${dst}`);
        if (!r.ok) throw new Error(`API ${r.status}`);
        const geo = await r.json();
        routeLayer.clearLayers();

        // Manejo de “geometry:null” (no hay ruta en el grafo)
        const geom = geo?.features?.[0]?.geometry || null;
        if (!geom) {
          routeInfo.textContent = 'Sin ruta posible entre los puntos (grafo desconectado).';
          return;
        }

        const route = L.geoJSON(geo, {style:{color:'#ff006e', weight:5}});
        routeLayer.addLayer(route);
        try { map.fitBounds(route.getBounds(), {padding:[20,20]}); } catch(_){}
        routeInfo.textContent = `Ruta lista ${src} → ${dst}`;
      } catch(e) {
        // Si ves “TypeError: Failed to fetch” aquí, es CORS (puertos 8080→8000)
        routeInfo.textContent = `Error: ${e.message}`;
        console.error(e);
      }
    }

    function enableRouting() {
      routingMode = true;
      resetRoute();
      routeInfo.textContent = 'Haz 2 clics en el mapa (origen y destino).';
      map.getContainer().style.cursor = 'crosshair';
    }
    function disableRouting() {
      routingMode = false;
      map.getContainer().style.cursor = '';
      routeInfo.textContent = '';
    }

    map.on('click', (ev)=>{
      if (!routingMode) return;
      const {lat, lng} = ev.latlng;
      const n = picks.length + 1;
      const m = L.marker([lat,lng], {opacity:0.9})
                 .bindTooltip(n===1?'Origen':'Destino', {permanent:true, offset:[0,-16]});
      routeMarkers.addLayer(m);
      picks.push({lat,lng});
      if (picks.length === 2) requestRoute();
      else routeInfo.textContent = 'Selecciona destino…';
    });

    chkRoute.addEventListener('change', e=>{
      if (e.target.checked) enableRouting();
      else { disableRouting(); resetRoute(); }
    });
    btnReset.addEventListener('click', ()=>{
      resetRoute();
      if (routingMode) routeInfo.textContent = 'Haz 2 clics en el mapa (origen y destino).';
    });

    // --- CARGAS INICIALES ---
    (async()=>{
      await loadInfra();
      await loadBeb();
      await loadTemp();
      await loadUV();
      await loadSombraStatic();
    })();
  </script>
</body>
</html>
